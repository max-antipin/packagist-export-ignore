#!/usr/bin/env php
<?php
declare(strict_types=1);
function runCmd(string $cmd, ?callable $callback = null, ...$args): array {
    $output = $result = null;
    exec($cmd, $output, $result);
    if (0 === $result) {
        if (null !== $callback) {
            foreach ($output as $str) {
                $callback($str, ...$args);
            }
        }
        return $output;
    }
    exit($result);
}
function fnmatches(array $patterns, string $file_name): bool {
    foreach ($patterns as $pattern) {
        if (fnmatch($pattern, $file_name)) {
            return true;
        }
    }
    return false;
}
function toStdOut(string $value, string ...$values): void {
    foreach ([$value, ...$values] as $text) {
        echo $text, PHP_EOL;
    }
}
function toStdErr(string $value, string ...$values): void {
    foreach ([$value, ...$values] as $text) {
        fwrite(STDERR, $text . PHP_EOL);
    }
}
$patternsToIgnore = ['.*', 'Tests/*', '*/Tests/*', '*.dist', '*.dist.*'];
$filesToIgnore = [];
$exportedFiles = runCmd(
    'git archive --format=tar --worktree-attributes HEAD | tar -t',
    static function (string $file_name, array $patterns) use (&$filesToIgnore): void {
        if (fnmatches($patterns, $file_name)) {
            $filesToIgnore[] = $file_name;
        }
    },
    $patternsToIgnore
);
if ($argc > 1) {
    if ('show-ignored' === $argv[1]) {
        $ignoredFiles = array_diff(runCmd('git ls-files'), $exportedFiles);
        if ($ignoredFiles) {
            toStdOut(...$ignoredFiles);
        }
    } elseif ('show-exported' === $argv[1]) {
        toStdOut(...$exportedFiles);
    } else {
        toStdErr('Invalid argument ' . $argv[1]);
        exit(2);
    }
} else {
    if ($filesToIgnore) {
        toStdOut(...$filesToIgnore);
        exit(1);
    }
}
